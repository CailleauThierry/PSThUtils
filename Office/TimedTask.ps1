<#
    .NOTES
    ===========================================================================
    Created on:   	Sunday November 20, 2016
    Created by:   	CailleauThierry
    Organization: 	Private
    Filename:		    TimedTask.ps1
    Version:        1.1.1.0
    Started from: 	https://github.com/Windos/powershell-depot/blob/master/General/Timesheet.ps1
    ===========================================================================
    .DESCRIPTION
    This is a simple .csv timesheet generation. Unlike Timesheet.ps1 it does not ask what you are doing every 20 min. 
    You are meant to launch TimedTask.bat every time you want to make an entry to today's sheet 
    .EXAMPLE
    - Launch TimedTask.bat every time you want to record the time taken to perform a task. Only press "Enter" / "OK" once the task is complete.
    .FUNCTIONALITY
    - TimedTask.ps1 version 1.1.0.0 autoupdates Categories
    - TimedTask.ps1 based on Timesheet.ps1 but records beginning and end time instead. This is meant to be uses as launching a script for each tasks.
    - This version adds date-stamp to the generated .csv file
    - This version removes Type information in the generated .csv file (-NoTypeInformation)
    - You can also add a start menu shortcut launch "TimedTask.ps1 - Shortcut" (some small bugs detected with 2 popup after a while... ...better wait before using) to place in either following directories:
      Autostart for currently logged-on user:
      shell:startup = %appdata%\Microsoft\Windows\Start Menu\Programs\Startup
      And startup folder all users:
      shell:common startup = %programdata%\Microsoft\Windows\Start Menu\Programs\Startup
    .NOTES
    - When editing in excel the double quotes generated by this script get removed for the csv > do not save the .csv after opening in Excel
    - no need to check if timesheet already existing as it is date-tagged
       Ideas for improvement:
    - Need to scan text to auto-detect Categories
    - need to bring windows to front whent he script starts (and still be able to fade to background...)
#>

#Requires -Version 5

#Time the script is launched at
$Start_Time = (Get-Date)

# Format today's date in the way that can be appended to a file name
$MyDate = (Get-Date).ToShortDateString().Replace('/', '_')

# Adding date to filename
$Filename = $MyDate + '_' + 'timesheet.csv'
$TSPath = Join-Path (Split-Path $profile) "$Filename"

class TSEntry {
  #region properties
  [datetime]$DateTime
  [string]$Duration
  [string]$Category
  [string]$Ticket
  [string]$Activity
  #endregion
	
  #region constructors
  TSEntry([datetime]$DateTime, [string]$Duration, [string]$Category, [string]$Ticket, [string]$Activity)
  {
    $this.DateTime = $DateTime
    $this.Duration = $Duration
    $this.Category = $Category
    $this.Ticket = $Ticket
    $this.Activity = $Activity
  }
  #endregion
	
  #region methods
	
  #endregion
}

function New-TSEntry
{
  Add-Type -AssemblyName Microsoft.VisualBasic # The input box object comes care of VisualBasic
	
  $TSPrompt = 'What are you working on?'
  $TSTitle = 'Timesheet'
  $TSDefault = ''
  $DefaultCategory = 'L3 Mentee Review'
  $TicketNumber = 'N/A'
  
  $entry = [Microsoft.VisualBasic.Interaction]::InputBox($TSPrompt, $TSTitle, $TSDefault)
	
  #Find if the typed entry contains a ticket number (7 or 8 digits, 7 if you miss to trype the leading 0)
  $entry -match '(?<ticket>(\d{7,8}))'
  if ($Matches){
    $TicketNumber = $Matches.ticket
  }
	
	
  $Log = New-Object PSObject	
  #Log object definition also defines in what order the objects will be displayed at the end.

  $Log | Add-Member NoteProperty Administration "$null"
  $Log | Add-Member NoteProperty Break "$null"
  $Log | Add-Member NoteProperty Chat "$null"
  $Log | Add-Member NoteProperty Developement "$null"
  $Log | Add-Member NoteProperty DTS "$null"
  $Log | Add-Member NoteProperty Escalation "$null"
  $Log | Add-Member NoteProperty G2A "$null"
  $Log | Add-Member NoteProperty InboundCall "$null"
  $Log | Add-Member NoteProperty InternalRequest "$null"
  $Log | Add-Member NoteProperty L3Review "$null"
  $Log | Add-Member NoteProperty Management "$null"
  $Log | Add-Member NoteProperty Queue "$null"
  $Log | Add-Member NoteProperty Supervising "$null"
  $Log | Add-Member NoteProperty Training "$null"
	
  # key0 uses RegEx Expression Matching for key0 identifier. key1 is the PSObject Property Name
  $A0 = @{ key0 = '(?<RegExMatch>(appointment|signing|login|updated|building|timesheet|One-on-One))'; key1 = 'Administration' } # need to us -imatch for case insensitive matching
  $A1 = @{ key0 = '(?<RegExMatch>(break|lunch))'; key1 = 'Break' } # need to us -imatch for case insensitive matching
  $A2 = @{ key0 = '(?<RegExMatch>(Chat))'; key1 = 'Chat' } # need to us -imatch for case insensitive matching
  $A3 = @{ key0 = '(?<RegExMatch>(installed|editing|github|script|ps1))'; key1 = 'Developement' } # need to us -imatch for case insensitive matching
  $A4 = @{ key0 = '(?<RegExMatch>(DTS))'; key1 = 'DTS' } # need to us -imatch for case insensitive matching
  $A5 = @{ key0 = '(?<RegExMatch>(escalation))'; key1 = 'Escalation' } # need to us -imatch for case insensitive matching
  $A6 = @{ key0 = '(?<RegExMatch>(G2A))'; key1 = 'G2A' } # need to us -imatch for case insensitive matching
  $A7 = @{ key0 = '(?<RegExMatch>(inbound|call))'; key1 = 'InboundCall' } # need to us -imatch for case insensitive matching
  $A8 = @{ key0 = '(?<RegExMatch>(Shaun|Mathieu|internal|Kevin|Bloks|Bramley))'; key1 = 'InternalRequest' } # need to us -imatch for case insensitive matching
  $A9 = @{ key0 = "(?<RegExMatch>(Skott|PR'ed))"; key1 = 'L3Review' } # need to us -imatch for case insensitive matching
  $A10 = @{ key0 = '(?<RegExMatch>(management))'; key1 = 'Management' } # need to us -imatch for case insensitive matching
  $A11 = @{ key0 = '(?<RegExMatch>(queue|articles))'; key1 = 'Queue' } # need to us -imatch for case insensitive matching
  $A12 = @{ key0 = '(?<RegExMatch>(meeting))'; key1 = 'Supervising' } # need to us -imatch for case insensitive matching
  $A13 = @{ key0 = '(?<RegExMatch>(training))'; key1 = 'Training' } # need to us -imatch for case insensitive matching
	
	
  #  $A14 = @{ key0 = '(?<RegExMatch>(\d{7,8}))'; key1 = 'TicketNumber' } # '(?<TicketNumber>(\d{7,8}))' matching format '01052582' or '1052582'
	
  $Keys = @(
    $A0,
    $A1,
    $A2,
    $A3,
    $A4,
    $A5,
    $A6,
    $A7,
    $A8,
    $A9,
    $A10,
    $A11,
    $A12,
    $A13
  )
	
  for ($counter = 0; $counter -lt $Keys.Length; $counter++)
  {
    # $Keys.Length > autoadjust if you add more identification keys
    # $consume consumes the result of the pipe since we are not directly interested by the pipe result but its side product from the $matches automatic variable and if true or false match for the conditional if loop
    $consume = $entry | Where-Object { $_ -match $Keys[$counter].key0 }
		
    # key2 Property (like AgentVersion, HostName, TaskName. This is the resulte of observer redundancies and size optimzation of the code
		
    if ($consume -notlike "$null")
    {
      $temp = $Keys[$counter].key1
      $Log."$temp" = $Matches.RegExMatch #this show the matched keywords for debugging
      $DefaultCategory = $temp
    }
  }
	
  # Calculate the duration of the task and returns in a mmmm.ss format (minutes . seconds format)
  [string]$CalculatedTaskDuration = "$(((Get-Date) - ($Start_Time)).Minutes)" + '.' + "$(((Get-Date) - ($Start_Time)).Seconds)"
	
  $result = [TSEntry]::new((Get-Date), $CalculatedTaskDuration, $DefaultCategory, $TicketNumber, $entry)
	
  # Creates a csv file with the Properties as header paramaters by default. If file already exist Export-Csv already only appends a new line / raw
  # Note: if the .csv is open in Excel, the entry will not be added (there might be an Excel option to allow for .csv to be overwritten, but better not open Excel until the end of the day)
  $result | Export-Csv -Path $TSPath -NoTypeInformation -Append
}
  # launch the class function creating a new csv and an entry to it
  New-TSEntry
